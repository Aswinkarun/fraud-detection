<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <title>Fraud Detection</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            background: #f7f7f7;
            padding: 40px;
        }

        h1 {
            color: #333;
        }

        form {
            margin-bottom: 20px;
            background: #fff;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        button {
            margin-left: 10px;
            padding: 8px 16px;
            background-color: #007bff;
            border: none;
            color: white;
            border-radius: 5px;
            cursor: pointer;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            background: #fff;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            border-radius: 10px;
            overflow: hidden;
        }

        th, td {
            padding: 12px 16px;
            text-align: left;
            border-bottom: 1px solid #eee;
        }

        th {
            background-color: #007bff;
            color: white;
        }

        .fraud-true {
            color: red;
            font-weight: bold;
        }

        .fraud-false {
            color: green;
            font-weight: bold;
        }
        .rule-badge {
		    display: inline-block;
		    background-color: #ffc107;
		    color: #000;
		    padding: 4px 8px;
		    margin: 2px;
		    border-radius: 12px;
		    font-size: 12px;
		    cursor: default;
		}
		
		.details {
			display : none;
			background-color: #f1f1f1;
		}
		
		.fraud-row {
			background-color: #ffe6e6;
		}
		
		.safe-row {
			background-color: #e6ffe6;
		}
		
		.toggle-btn {
			cursor: pointer;
			color: #007bff;
			text-decoration: underline;
		}
		        
    </style>
</head>
<body>

    <h1>Upload Transaction Excel File</h1>

    <form method="POST" enctype="multipart/form-data" action="/upload" onsubmit="clearTable()">
        <input type="file" name="file" id="file" required />
        <button type="submit">Upload</button>
    </form>

    <p id="message" th:text="${message}"></p>

    <h2>Fraud Detection Stream:</h2>
    <table>
        <thead>
            <tr>
            	<th>#</th>
                <th>Transaction ID</th>
                <th>Fraud</th>
                <th>Rules Violated</th>
                <th>Warnings</th>
                <th>Details</th>
            </tr>
        </thead>
        <tbody id="results-body"></tbody>
    </table>
	
	<div id="details"></div>
	
	<script>
    let eventSource = null;
    let serialNumber = 1;
	let receivedCount=0;
	
    function startSSE() 
    {
        //if (eventSource) return; // Prevent duplicate SSE connections
		
        //const details = document.getElementById("details");
        
        eventSource = new EventSource("/fraud-stream");
        const tableBody = document.getElementById("results-body");

        eventSource.onmessage = function (event) 
        {
            const data = JSON.parse(event.data);
            const row = document.createElement("tr");
            row.classList.add(data.isFraud ? 'fraud-row' : 'safe-row');
            
            const detailsId = `details-${serialNumber}`;

            row.innerHTML = `
           		<td>${serialNumber++}</td>
                <td>${data.transactionID}</td>
                <td class="${data.isFraud ? 'fraud-true' : 'fraud-false'}">${data.isFraud}</td>
                <td>${data.rulesViolated}</td>
                <td>
                    ${data.violatedRules.map(rule => `<span class="rule-badge" title="${rule}">${rule}</span>`).join(" ")}
                </td>
                <td><span class="toggle-btn" onclick="toggleDetails('${detailsId}')">Show</span></td>
            `;
            
            const detailsRow = document.createElement("tr");
            detailsRow.id = detailsId;
            detailsRow.className = "details";
            detailsRow.innerHTML = `
            	<td colspan="6">
            		<strong>Name:</strong> ${data.name} |
            		<strong>Account Number:</strong> ${data.accountNumber} |
            		<strong>Mode:</strong> ${data.mode} |
            		<strong>Card Usage:</strong> ${data.cardUsage} |
            		<strong>Age:</strong> ${data.age}
            	</td>
            `;
			
            tableBody.prepend(detailsRow);
            tableBody.prepend(row);
            
            console.log("Received message:", data);
            
            receivedCount++;
            console.log("Received message #" + receivedCount);
        };
    }
    
    function toggleDetails(id)
    {
    	const row = document.getElementById(id);
    	row.style.display = row.style.display === "table-row" ? "none" : "table-row";
    }

    function clearTable() {
        document.getElementById("results-body").innerHTML = "";
        serialNumber = 1;
        
        if(eventSource)
        {
        	eventSource.close();
        }
        startSSE();
    }

    window.onload = function () 
    {
        startSSE(); // initialize SSE once on load
    };
</script>
 
</body>
</html>
